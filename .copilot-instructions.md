# Parakeet FastAPI Application - Copilot Instructions

## Project Overview

Parakeet is a simple, well-structured FastAPI application that serves as a microservice providing basic endpoints. The application returns "I'm a Parakeet" from its main endpoint and includes health checking capabilities. It's designed with modern Python development practices, containerization, and Kubernetes deployment in mind.

**Key Characteristics:**
- **Simplicity**: Focused, minimal API with clear purpose
- **Modern Stack**: FastAPI with Python 3.12+ and UV package management
- **Production Ready**: Includes health checks, containerization, and K8s deployment
- **Well Tested**: Comprehensive unit and integration test coverage
- **Cloud Native**: Designed for containerized deployment

## Technology Stack

### Core Technologies
- **FastAPI**: Modern, fast web framework for building APIs with Python
- **Python 3.12+**: Latest Python version with modern language features
- **UV**: Fast Python package installer and resolver (alternative to pip)
- **Uvicorn**: ASGI server for running FastAPI applications

### Development Tools
- **Pytest**: Testing framework with fixtures and parametrization
- **HTTPX**: Modern HTTP client for testing and async requests
- **Docker**: Containerization using amazonlinux:2023 base image
- **Kubernetes**: Orchestration with deployments and services

## Project Structure

```
parakeet/
├── src/
│   └── parakeet/
│       ├── __init__.py
│       └── main.py              # FastAPI application entry point
├── tests/
│   ├── __init__.py
│   ├── test_unit.py            # Unit tests with TestClient
│   └── test_integration.py     # Full HTTP integration tests
├── pyproject.toml              # UV dependencies and project config
├── Dockerfile                  # Multi-stage container build
├── deployment.yaml             # Kubernetes deployment configuration
├── .python-version            # Python version specification
├── uv.lock                     # Dependency lock file
└── README.md                   # Documentation
```

## Development Patterns

### FastAPI Application Structure

```python
# Standard FastAPI app initialization
app = FastAPI(
    title="Parakeet API",
    description="A simple FastAPI application that responds 'I'm a Parakeet'",
    version="0.1.0"
)

# Async endpoint pattern
@app.get("/endpoint")
async def endpoint_handler():
    """Docstring describing the endpoint."""
    return {"key": "value"}
```

### Code Style and Conventions

- **Type Hints**: Use type annotations for all function parameters and return values
- **Async/Await**: Prefer `async def` for endpoint handlers even if not strictly required
- **Docstrings**: Include descriptive docstrings for all endpoints and functions
- **JSON Responses**: Return dictionaries that FastAPI automatically converts to JSON
- **Error Handling**: Use FastAPI's HTTPException for proper error responses

### Endpoint Patterns

```python
# Health check endpoint (required for Kubernetes)
@app.get("/health")
async def health_check():
    """Health check endpoint for Kubernetes."""
    return {"status": "healthy"}

# Business logic endpoint
@app.get("/hello")
async def hello():
    """Return a greeting from the parakeet."""
    return {"message": "I'm a Parakeet"}
```

## Testing Strategy

### Unit Testing with TestClient

```python
from fastapi.testclient import TestClient
from src.parakeet.main import app

client = TestClient(app)

def test_endpoint():
    """Test endpoint returns expected response."""
    response = client.get("/endpoint")
    assert response.status_code == 200
    assert response.json() == {"expected": "response"}
```

### Integration Testing with Real HTTP

```python
import httpx
import subprocess

class TestIntegration:
    @pytest.fixture(scope="class")
    def server_process(self):
        """Start real server for integration testing."""
        process = subprocess.Popen([
            "uv", "run", "python", "-m", "uvicorn", 
            "src.parakeet.main:app", "--host", "127.0.0.1", "--port", "8001"
        ])
        time.sleep(2)  # Wait for startup
        yield process
        process.terminate()

    def test_real_http(self, server_process):
        """Test with real HTTP requests."""
        response = httpx.get("http://127.0.0.1:8001/hello")
        assert response.status_code == 200
```

### Test Organization

- **Unit Tests**: Fast tests using FastAPI's TestClient (no real HTTP)
- **Integration Tests**: Full HTTP tests with real server process
- **Test Coverage**: Include positive cases, error conditions, and edge cases
- **Test Isolation**: Each test should be independent and idempotent

## Development Workflow

### Local Development

```bash
# Install dependencies
uv sync --extra test

# Run the application
uv run python -m uvicorn src.parakeet.main:app --host 0.0.0.0 --port 8000

# Access the application
curl http://localhost:8000/hello
curl http://localhost:8000/health
open http://localhost:8000/docs  # OpenAPI documentation
```

### Testing Commands

```bash
# Run all tests
uv run pytest -v

# Run specific test types
uv run pytest tests/test_unit.py -v        # Unit tests only
uv run pytest tests/test_integration.py -v # Integration tests only

# Test with coverage
uv run pytest --cov=src tests/ -v
```

### Package Management with UV

```bash
# Add new dependency
uv add package-name

# Add development dependency
uv add --dev package-name

# Sync dependencies from lock file
uv sync

# Update dependencies
uv update
```

## Containerization and Deployment

### Docker Container

- **Base Image**: amazonlinux:2023 for security and compatibility
- **Multi-stage Build**: Separates build dependencies from runtime
- **Security**: Runs as non-root user
- **Port**: Exposes port 8000

```dockerfile
# Production container runs uvicorn server
CMD ["uv", "run", "python", "-m", "uvicorn", "src.parakeet.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### Kubernetes Deployment

```yaml
# Deployment with 2 replicas for high availability
apiVersion: apps/v1
kind: Deployment
spec:
  replicas: 2
  template:
    spec:
      containers:
      - name: parakeet
        image: parakeet:latest
        ports:
        - containerPort: 8000
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
```

## Code Quality and Standards

### Import Organization

```python
# Standard library imports
import asyncio
import time
from typing import Dict, Any

# Third-party imports
from fastapi import FastAPI, HTTPException
import uvicorn

# Local imports
from src.parakeet.models import SomeModel
```

### Error Handling

```python
from fastapi import HTTPException

@app.get("/endpoint")
async def endpoint():
    try:
        # Business logic
        result = some_operation()
        return {"result": result}
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception:
        raise HTTPException(status_code=500, detail="Internal server error")
```

### Configuration Management

- Use environment variables for configuration
- Provide sensible defaults
- Validate configuration at startup
- Use Pydantic for settings management when needed

## API Design Principles

### Response Format

```python
# Consistent JSON response structure
{
    "message": "Success response data",
    "status": "success"  # Optional for simple responses
}

# Error responses (handled by FastAPI)
{
    "detail": "Error message describing what went wrong"
}
```

### Endpoint Naming

- Use kebab-case for URLs: `/api/health-check`
- Use plural nouns for collections: `/api/users`
- Use clear, descriptive names: `/hello` not `/h`
- Include version in API paths when needed: `/api/v1/hello`

### OpenAPI Documentation

- All endpoints automatically documented via FastAPI
- Include meaningful descriptions in docstrings
- Use response models for complex responses
- Tag related endpoints for organization

## Security Considerations

- **Input Validation**: Pydantic models for request validation
- **CORS**: Configure appropriately for cross-origin requests
- **Rate Limiting**: Consider adding for production use
- **Authentication**: Add JWT or similar when needed
- **HTTPS**: Always use in production (handled by ingress/load balancer)

## Monitoring and Observability

### Health Checks

```python
@app.get("/health")
async def health_check():
    """Kubernetes health check endpoint."""
    # Add database connectivity checks, external service checks, etc.
    return {"status": "healthy", "timestamp": datetime.utcnow()}
```

### Logging

```python
import logging

logger = logging.getLogger(__name__)

@app.get("/endpoint")
async def endpoint():
    logger.info("Processing request for endpoint")
    # ... business logic
    logger.info("Request processed successfully")
```

## Common Operations

### Adding a New Endpoint

1. Add the endpoint handler to `src/parakeet/main.py`
2. Include proper type hints and docstring
3. Add unit tests in `tests/test_unit.py`
4. Add integration tests in `tests/test_integration.py`
5. Update OpenAPI documentation if needed
6. Test locally and verify OpenAPI docs at `/docs`

### Extending the Application

- **New Features**: Add as separate routers when application grows
- **Database**: Add SQLAlchemy or similar ORM with async support
- **Background Tasks**: Use FastAPI's BackgroundTasks or Celery
- **Middleware**: Add for cross-cutting concerns (logging, auth, etc.)

### Deployment Updates

1. Update version in `pyproject.toml`
2. Build and test Docker container locally
3. Run full test suite including integration tests
4. Deploy to staging environment first
5. Verify health checks and functionality
6. Deploy to production with rolling update strategy

## Troubleshooting

### Common Issues

- **Port Conflicts**: Change port in uvicorn command if 8000 is occupied
- **UV Not Found**: Install UV or use pip as fallback for development
- **Import Errors**: Ensure PYTHONPATH includes project root
- **Test Failures**: Check for port conflicts in integration tests

### Debug Mode

```bash
# Run with auto-reload for development
uv run python -m uvicorn src.parakeet.main:app --reload --host 0.0.0.0 --port 8000

# Run with debug logging
uv run python -m uvicorn src.parakeet.main:app --log-level debug
```

This application follows modern Python and FastAPI best practices. When extending functionality, maintain the existing patterns for consistency and reliability.